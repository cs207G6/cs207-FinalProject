<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<form>
    <input type="file" id="xml_upload" name="xml_upload[]" multiple="">

    <p id="file_upload_result"></p>

    <div id="species">
    </div>

    <label for="_temp">Temperature</label><input id="_temp" value="100">

    <input type="button" id="get_rates" value="Get Rates">

    <p id="progress_rates"></p>
    <p id="reaction_rates"></p>
</form>

<script type="text/javascript">
    session_id = "NONE";

    function createSession(evt) {
        document.getElementById('file_upload_result').innerText = "Uploading";
        var files = evt.target.files;
        if (files.length === 0) {
            return;
        }
        var file = files[0];

        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = function (e) {
            var xml_data = e.target.result;
            var xhr = new XMLHttpRequest();

            xhr.open('POST', '/session');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    console.log(xhr.responseText);
                    document.getElementById('file_upload_result').innerText = "Uploaded";
                    var response = JSON.parse(xhr.responseText);
                    if (response['status'] === 'failed') {
                        alert(response['reason']);
                        return;
                    }
                    session_id = response['id'];
                    species = response['species'];
                    showSpecies();
                }
                else {
                    alert('Request failed.  Returned status of ' + xhr.status);
                }
            };
            xhr.send(JSON.stringify({"data": xml_data}));

        };

        reader.readAsText(file);

    }

    function showSpecies() {
        document.getElementById('species').innerHTML = "";
        for (var i = 0; i < species.length; i++) {
            var sp = species[i];
            var div = document.createElement("div");
            var label = document.createElement('p');
            label.innerText = sp;
            div.appendChild(label);
            var input = document.createElement("input");
            input.id = "species_" + sp;
            input.value = 0;
            div.appendChild(input);
            document.getElementById('species').appendChild(div);
        }
    }

    function getRates() {
        if (session_id === "NONE") {
            alert("Must upload xml file first!");
            return;
        }

        var request_para = {};
        for (var i = 0; i < species.length; i++) {
            var sp = species[i];
            var id = "species_" + sp;
            request_para[sp] = 1;

            var val = Number(document.getElementById(id).value);
            if (Number.isNaN(val) || val < 0) {
                alert("Invalid input for " + sp);
                return;
            }
            request_para[sp] = val;
        }
        var temp = Number(document.getElementById('_temp').value);

        if (Number.isNaN(temp) || temp <= 0) {
            alert("Invalid input for temperature");
            return;
        }

        request_para['_temp'] = temp;


        var xhr = new XMLHttpRequest();

        xhr.open('POST', '/rates/' + session_id);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log(xhr.responseText);
                var response = JSON.parse(xhr.responseText);
                if (response['status'] === 'failed') {
                    alert(response['reason']);
                    return;
                }
                document.getElementById('progress_rates').innerText = response['progress_rates'];
                document.getElementById('reaction_rates').innerText = response['reaction_rates'];
            }
            else {
                alert('Request failed.  Returned status of ' + xhr.status);
            }
        };
        xhr.send(JSON.stringify(request_para));
    }

    document.getElementById('xml_upload').addEventListener('change', createSession, false);
    document.getElementById('get_rates').addEventListener('click', getRates, false);
</script>

</body>
</html>